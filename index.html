<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Préstamo - Posgrados</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import {
          getFirestore, collection, getDocs, getDoc, setDoc, deleteDoc, updateDoc, doc
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // POSGRADOS - configuración (mantener la del proyecto de posgrados)
        const firebaseConfig = {
          apiKey: "AIzaSyC7llIg5wLu8P_5WBbjg4GW3orZZ1w8_vE",
          authDomain: "prestamos-1efef.firebaseapp.com",
          projectId: "prestamos-1efef",
          storageBucket: "prestamos-1efef.firebasestorage.app",
          messagingSenderId: "977813237082",
          appId: "1:977813237082:web:576287c13c305db3811763"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Buscar usuario por documento y autocompletar
        window.buscarUsuario = async function () {
          const documento = document.getElementById("documento").value.trim();
          if (!documento) return;
          try {
            const ref = doc(db, "usuarios", documento);
            const snap = await getDoc(ref);
            if (snap.exists()) {
              const u = snap.data();
              document.getElementById("nombre").value = u.nombre || "";
              document.getElementById("tipoUsuario").value = u.tipoUsuario || "";
              document.getElementById("facultad").value = u.facultad || "";
            }
          } catch (e) {
            console.error("Error buscarUsuario:", e);
          }
        };

        // Añadir dinámicamente salones
        window.agregarSalon = function () {
          const contenedor = document.getElementById("salones-container");
          const nuevo = document.createElement("div");
          nuevo.className = "salon-item";
          nuevo.innerHTML = `
            <input type="text" class="salon" placeholder="Salón (ej: 301P)">
            <label>Hora entrega:</label>
            <input type="time" class="horaEntrega">
            <label>Hora devolución:</label>
            <input type="time" class="horaDevolucion">
            <button type="button" onclick="this.parentElement.remove()">❌</button>
          `;
          contenedor.appendChild(nuevo);
        };

        // Normalizador de tipo de usuario (acepta variantes mínimas pero exige los tres)
        function normalizarTipoUsuario(raw) {
          if (!raw) return "";
          const v = raw.trim().toLowerCase();
          if (v.includes("doc" ) || v.includes("profe") || v.includes("form")) return "Docente";
          if (v.includes("estud") || v.includes("alu") || v.includes("apr")) return "Estudiante";
          if (v.includes("admin") || v.includes("admi")) return "Administrativo";
          return ""; // invalido
        }

        function validarTipoUsuarioCampo() {
          const tipoInput = document.getElementById("tipoUsuario").value;
          const normal = normalizarTipoUsuario(tipoInput);
          if (!normal) {
            alert("⚠️ Tipo de usuario inválido. Sólo se permite: Docente, Estudiante o Administrativo.");
            return false;
          }
          // poner en formato capitalizado
          document.getElementById("tipoUsuario").value = normal;
          return true;
        }

        // Calcular horas netas entre dos horas (formato HH:MM)
        function calcularHorasNetas(horaInicio, horaFin) {
          try {
            if (!horaInicio || !horaFin) return 0;
            const inicio = new Date(`1970-01-01T${horaInicio}:00`);
            const fin = new Date(`1970-01-01T${horaFin}:00`);
            const diff = (fin - inicio) / (1000 * 60 * 60);
            return diff > 0 ? Math.round((diff + Number.EPSILON) * 100) / 100 : 0;
          } catch (e) {
            console.error("calcularHorasNetas error", e);
            return 0;
          }
        }

        // Función principal para agregar préstamo (adaptada a posgrados)
        window.agregarPrestamo = async function () {
          const nombre = document.getElementById("nombre").value.trim();
          const documento = document.getElementById("documento").value.trim();
          let tipoUsuarioRaw = document.getElementById("tipoUsuario").value.trim();
          const facultad = document.getElementById("facultad").value.trim();

          // Salones (múltiples)
          const salones = [];
          document.querySelectorAll("#salones-container .salon-item").forEach(div => {
            const nombreSalon = div.querySelector(".salon").value.trim();
            const horaEntrega = div.querySelector(".horaEntrega").value;
            const horaDevolucion = div.querySelector(".horaDevolucion").value;
            if (nombreSalon && horaEntrega && horaDevolucion) {
              const horas = calcularHorasNetas(horaEntrega, horaDevolucion);
              salones.push({ nombre: nombreSalon, horaEntrega, horaDevolucion, horas });
            }
          });

          if (salones.length === 0) {
            alert("Por favor, agregue al menos un salón con horario.");
            return;
          }

          // Leer cantidades de equipos (en POSGRADOS usamos PORTATIL genérico)
          const cantidades = document.querySelectorAll(".cantidad-equipo");
          let equipos = [];
          cantidades.forEach(input => {
            const cantidad = parseInt(input.value) || 0;
            if (cantidad > 0) {
              equipos.push({ nombre: input.dataset.equipo, cantidad });
            }
          });

          // Campo "otros"
          const otros = document.getElementById("otros").value.trim();
          if (otros) equipos.push({ nombre: otros, cantidad: 1 });

          if (!nombre || !documento || !facultad || salones.length === 0 || equipos.length === 0) {
            alert("Por favor, complete todos los campos y agregue al menos un equipo.");
            return;
          }

          // Validar tipo de usuario (igual que en pregrado: estricto pero con normalización)
          const normal = normalizarTipoUsuario(tipoUsuarioRaw);
          if (!normal) {
            alert("⚠️ Tipo de usuario inválido. Sólo se permite: Docente, Estudiante o Administrativo.");
            return;
          }
          const tipoUsuario = normal; // ya en formato capitalizado

          // Calcular total de horas sumando salones
          const totalHoras = salones.reduce((s, it) => s + (parseFloat(it.horas) || 0), 0);

          const fecha = new Date().toLocaleDateString("es-CO");
          const id = `${documento}_${Date.now()}`; // id único si se registran varias entradas por doc

          const prestamo = {
            nombre,
            documento,
            tipoUsuario,
            facultad,
            salones,
            totalHoras,
            equipos,
            devuelto: false,
            fecha
          };

          try {
            // Guardar préstamo
            await setDoc(doc(db, "prestamos", id), prestamo);

            // Guardar/actualizar usuario
            const usuarioRef = doc(db, "usuarios", documento);
            const usuarioSnap = await getDoc(usuarioRef);
            if (!usuarioSnap.exists()) {
              await setDoc(usuarioRef, { nombre, documento, tipoUsuario, facultad });
            } else {
              const datosActuales = usuarioSnap.data() || {};
              const cambios = {};
              if (nombre && nombre !== datosActuales.nombre) cambios.nombre = nombre;
              if (tipoUsuario && tipoUsuario !== datosActuales.tipoUsuario) cambios.tipoUsuario = tipoUsuario;
              if (facultad && facultad !== datosActuales.facultad) cambios.facultad = facultad;
              if (Object.keys(cambios).length > 0) await updateDoc(usuarioRef, cambios);
            }

            alert('✅ Préstamo registrado correctamente.');

            // Limpiar formulario
            document.getElementById("documento").value = "";
            document.getElementById("nombre").value = "";
            document.getElementById("tipoUsuario").value = "";
            document.getElementById("facultad").value = "";
            document.getElementById("otros").value = "";

            // Reiniciar salones
            const salonesContainer = document.getElementById("salones-container");
            salonesContainer.innerHTML = `
              <div class="salon-item">
                <input type="text" class="salon" placeholder="Salón (ej: 301P)">
                <label>Hora entrega:</label>
                <input type="time" class="horaEntrega">
                <label>Hora devolución:</label>
                <input type="time" class="horaDevolucion">
              </div>
            `;

            // Reiniciar cantidades
            document.querySelectorAll('.cantidad-equipo').forEach(i => i.value = 0);

            if (typeof cargarDatos === 'function') cargarDatos();
          } catch (err) {
            console.error('Error guardando préstamo:', err);
            alert('Error al guardar préstamo. Revisa la consola.');
          }
        };

        // Funciones para listar / editar / eliminar / marcar devuelto
        async function cargarDatos() {
          const contenedor = document.getElementById("listaPrestamos");
          if (!contenedor) return;
          contenedor.innerHTML = "";
          try {
            const snapshot = await getDocs(collection(db, "prestamos"));
            const prestamos = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            prestamos.forEach(prestamo => {
              const card = document.createElement('div');
              card.className = 'card';
              card.classList.add(prestamo.devuelto ? 'prestamo-devuelto' : 'prestamo-activo');

              const salonesText = Array.isArray(prestamo.salones)
                ? prestamo.salones.map(s => `${s.nombre} (${s.horaEntrega} → ${s.horaDevolucion})`).join(', ')
                : (prestamo.salon || 'No registrado');

              const equiposText = Array.isArray(prestamo.equipos)
                ? prestamo.equipos.map(e => `${e.nombre || e} (x${e.cantidad||1})`).join(', ')
                : 'Sin datos';

              card.innerHTML = `
                <div class="card-header">
                  <span>${prestamo.nombre} - ${prestamo.documento}</span>
                  <span>${prestamo.devuelto ? 'Devuelto' : 'En préstamo'}</span>
                </div>
                <div class="card-body">
                  <p><strong>Tipo de Usuario:</strong> ${prestamo.tipoUsuario}</p>
                  <p><strong>Facultad:</strong> ${prestamo.facultad}</p>
                  <p><strong>Salones:</strong> ${salonesText}</p>
                  <p><strong>Total horas:</strong> ${prestamo.totalHoras || 0}</p>
                  <p><strong>Equipos:</strong> ${equiposText}</p>
                  <button class="btn-edit" onclick="editarPrestamo('${prestamo.id}')">Editar</button>
                  <button class="btn-return" onclick="marcarDevuelto('${prestamo.id}')">Devolver</button>
                  <button class="btn-delete" onclick="eliminarPrestamo('${prestamo.id}')">Eliminar</button>
                </div>
              `;

              card.addEventListener('click', () => card.classList.toggle('expanded'));
              contenedor.appendChild(card);
            });
          } catch (e) {
            console.error('Error cargarDatos:', e);
          }
        }

        async function marcarDevuelto(id) {
          try {
            const ref = doc(db, 'prestamos', id);
            await updateDoc(ref, { devuelto: true });
            if (typeof cargarDatos === 'function') cargarDatos();
          } catch (e) { console.error(e); }
        }

        async function editarPrestamo(id) {
          try {
            const ref = doc(db, 'prestamos', id);
            const snap = await getDoc(ref);
            if (!snap.exists()) { alert('Préstamo no encontrado'); return; }
            const prestamo = snap.data();

            document.getElementById('documento').value = prestamo.documento || '';
            document.getElementById('nombre').value = prestamo.nombre || '';
            document.getElementById('tipoUsuario').value = prestamo.tipoUsuario || '';
            document.getElementById('facultad').value = prestamo.facultad || '';

            // Cargar salones en el form
            const sc = document.getElementById('salones-container');
            sc.innerHTML = '';
            (prestamo.salones || []).forEach(s => {
              const div = document.createElement('div');
              div.className = 'salon-item';
              div.innerHTML = `
                <input type="text" class="salon" value="${s.nombre}">
                <label>Hora entrega:</label>
                <input type="time" class="horaEntrega" value="${s.horaEntrega}">
                <label>Hora devolución:</label>
                <input type="time" class="horaDevolucion" value="${s.horaDevolucion}">
                <button type="button" onclick="this.parentElement.remove()">❌</button>
              `;
              sc.appendChild(div);
            });

            // Cargar equipos
            document.querySelectorAll('.cantidad-equipo').forEach(i => i.value = 0);
            (prestamo.equipos || []).forEach(e => {
              const nombre = e.nombre || e;
              const cantidad = e.cantidad || 1;
              const input = Array.from(document.querySelectorAll('.cantidad-equipo')).find(x => x.dataset.equipo === nombre);
              if (input) input.value = cantidad;
              else document.getElementById('otros').value = nombre; // si no existe, poner en otros
            });

            // Borrar doc para re-guardar (flujo del proyecto)
            await deleteDoc(ref);
            if (typeof cargarDatos === 'function') cargarDatos();
          } catch (e) { console.error('editarPrestamo error', e); }
        }

        async function eliminarPrestamo(id) {
          try {
            const ref = doc(db, 'prestamos', id);
            const snap = await getDoc(ref);
            if (!snap.exists()) return;
            const prestamoEliminado = snap.data();
            await deleteDoc(ref);

            // Guardar en historial con fecha
            const fechaHoy = new Date().toLocaleDateString('es-CO');
            const histId = `${prestamoEliminado.documento}_${Date.now()}`;
            await setDoc(doc(db, 'historial', histId), { ...prestamoEliminado, fecha: fechaHoy });

            if (typeof cargarDatos === 'function') cargarDatos();
          } catch (e) { console.error('eliminarPrestamo', e); }
        }

        // Inicializar carga
        window.addEventListener('DOMContentLoaded', cargarDatos);

        // Exponer firestore helpers si se necesitan
        window.firestore = { db, getFirestore, collection, doc, getDocs, getDoc, setDoc };

    </script>
    <style>
      table { width:100%; overflow-x:auto; display:block; }
      body { font-family: Arial, sans-serif; margin:20px; background:#f4f4f4 }
      .cantidad-equipo { width:70px; padding:8px; font-size:1.2em; text-align:center }
      input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { transform: scale(1.5); margin:0 5px }
      .prestamo-activo { background-color: rgba(255,255,0,0.2) }
      .prestamo-devuelto { background-color: rgba(0,255,0,0.2) }
      .container{ max-width:100%; margin:auto; background:white; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1) }
      input, select, button { margin:5px 0; padding:10px; width:98%; border:1px solid #ddd; border-radius:5px }
      .checkbox-container{ display:flex; flex-wrap:wrap; gap:80px }
      .checkbox-container label{ display:flex; align-items:center; gap:5px; background:#e8e8e8; padding:5px 10px; border-radius:5px }
      .card{ background:white; border:1px solid #ddd; border-radius:5px; padding:10px; margin:10px 0 }
      .card-header{ display:flex; justify-content:space-between }
      .card-body{ display:none; margin-top:10px }
      .card.expanded .card-body{ display:block }
      .btn-delete,.btn-edit,.btn-return{ color:white; border:none; padding:5px 10px; cursor:pointer; border-radius:5px }
      .btn-delete{ background:red } .btn-return{ background:green } .btn-edit{ background:orange }
      .checkbox-container label{ display:flex; align-items:center; justify-content:space-between; width:250px }
      .checkbox-container input[type="number"]{ width:60px; padding:5px; text-align:center }
      .salon-item{ display:flex; align-items:center; flex-wrap:wrap; gap:8px; margin-bottom:6px }
      .salon-item input[type="text"]{ width:120px }
      .salon-item input[type="time"]{ width:110px }
      .salon-item button{ background:red; color:white; border:none; border-radius:5px; padding:5px 8px; cursor:pointer }
    </style>
</head>
<body onload="cargarDatos()">
  <nav>
    <ul>
      <li><a href="index.html">Gestión de préstamos</a></li>
      <li><a href="activos.html">Préstamos activos</a></li>
      <li><a href="historial.html">Historial</a></li>
      <li><a href="estadisticas.html">Estadísticas</a></li>
    </ul>
  </nav>

  <div class="container">
    <h2>Gestión de Préstamos - Posgrados</h2>
    <div id="listaPrestamos"></div>

    <h2>Agregar Préstamo</h2>
    <input type="text" id="documento" placeholder="Número de documento" onblur="buscarUsuario()">
    <input type="text" id="nombre" placeholder="Nombre de la persona">
    <input type="text" id="tipoUsuario" placeholder="Tipo de usuario (Docente, Administrativo, Estudiante)">
    <input type="text" id="facultad" placeholder="Facultad">

    <fieldset>
      <legend>Salones y Horarios</legend>
      <div id="salones-container">
        <div class="salon-item">
          <input type="text" class="salon" placeholder="Salón (ej: 301P)">
          <label>Hora entrega:</label>
          <input type="time" class="horaEntrega">
          <label>Hora devolución:</label>
          <input type="time" class="horaDevolucion">
        </div>
      </div>
      <button type="button" onclick="agregarSalon()">+ Agregar otro salón</button>
    </fieldset>

    <fieldset>
      <legend>Equipo Prestado</legend>
      <div class="checkbox-container">
        <label>HDMI (TV)
          <input type="number" min="0" value="0" class="cantidad-equipo" data-equipo="HDMI (TV)">
        </label>
        <label>HDMI (ONESCREEN)
          <input type="number" min="0" value="0" class="cantidad-equipo" data-equipo="HDMI (ONESCREEN)">
        </label>
        <label>CONTROL (Videobeam)
          <input type="number" min="0" value="0" class="cantidad-equipo" data-equipo="CONTROL VB">
        </label>
        <label>HDMI (Videobeam)
          <input type="number" min="0" value="0" class="cantidad-equipo" data-equipo="HDMI (VIDEOBEAM)">
        </label>
        <label>PORTÁTIL
          <input type="number" min="0" value="0" class="cantidad-equipo" data-equipo="PORTATIL">
        </label>
        <label>ANCHOR
          <input type="number" min="0" value="0" class="cantidad-equipo" data-equipo="ANCHOR">
        </label>
      </div>
      <input type="text" id="otros" placeholder="Otros equipos">
    </fieldset>

    <button onclick="agregarPrestamo()">Agregar</button>

  </div>

  <b> © Juan Ladino - 2025 </b>
</body>
</html>