<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Pr√©stamo - Posgrados</title>

    <!-- üî• TODOS LOS ESTILOS ORIGINALES RESTAURADOS EXACTAMENTE COMO EN PREGRADO -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        table {
            width: 100%;
            overflow-x: auto;
            display: block;
        }
        input {
            margin: 5px 0;
            padding: 10px;
            width: 98%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        select {
            margin: 5px 0;
            padding: 10px;
            width: 94%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            margin: 5px 0;
            padding: 10px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        fieldset {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .container {
            max-width: 100%;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        .checkbox-container {
            display: flex;
            flex-wrap: wrap;
            gap: 80px;
        }
        .checkbox-container label {
            display: flex;
            align-items: center;
            gap: 5px;
            background: #e8e8e8;
            padding: 5px 10px;
            border-radius: 5px;
        }
        nav {
            background-color: #007BFF;
            padding: 10px;
            color: white;
        }
        nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: space-around;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            display: block;
        }
        nav ul li a:hover {
            background-color: #0056b3;
        }
        .card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            cursor: pointer;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
        }
        .card-body {
            display: none;
            margin-top: 10px;
        }
        .card.expanded .card-body {
            display: block;
        }
        .prestamo-activo {
            background-color: rgba(255,255,0,0.2);
        }
        .prestamo-devuelto {
            background-color: rgba(0,255,0,0.2);
        }
        .salon-item {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 6px;
        }
        .salon-item input[type="text"] {
            width: 120px;
        }
        .salon-item input[type="time"] {
            width: 110px;
        }
        .salon-item button {
            background: red;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 8px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<!-- üîê CONTRASE√ëA EXACTA RESTAURADA -->
<script>
  const claveCorrecta = "Chapi2025";
  const claveGuardada = sessionStorage.getItem("clavePrestamos");

  if (claveGuardada !== claveCorrecta) {
    const intento = prompt("üîê Ingresa la contrase√±a de acceso:");
    if (intento === claveCorrecta) {
      sessionStorage.setItem("clavePrestamos", claveCorrecta);
    } else {
      alert("Contrase√±a incorrecta.");
      window.location.href = "https://google.com";
    }
  }
</script>

<nav>
    <ul>
        <li><a href="index.html">Gesti√≥n de pr√©stamos</a></li>
        <li><a href="activos.html">Pr√©stamos activos</a></li>
        <li><a href="historial.html">Historial</a></li>
        <li><a href="estadisticas.html">Estad√≠sticas</a></li>
    </ul>
</nav>

<div class="container">

    <h2>Gesti√≥n de Pr√©stamos</h2>
    <div id="listaPrestamos"></div>

    <h2>Agregar Pr√©stamo</h2>

    <!-- üî• FORMULARIO ORIGINAL COMPLETO RESTAURADO -->
    <input type="text" id="documento" placeholder="N√∫mero de documento" onblur="buscarUsuario()">
    <input type="text" id="nombre" placeholder="Nombre de la persona">
    <input type="text" id="tipoUsuario" placeholder="Tipo de usuario (Docente, Administrativo, Estudiante)">
    <input type="text" id="facultad" placeholder="Facultad">

    <fieldset>
      <legend>Salones y Horarios</legend>
      <div id="salones-container">
        <div class="salon-item">
          <input type="text" class="salon" placeholder="Sal√≥n (ej: 301P)">
          <label>Hora entrega:</label>
          <input type="time" class="horaEntrega">
          <label>Hora devoluci√≥n:</label>
          <input type="time" class="horaDevolucion">
        </div>
      </div>
      <button type="button" onclick="agregarSalon()">+ Agregar otro sal√≥n</button>
    </fieldset>

    <fieldset>
      <legend>Equipo Prestado</legend>
      <div class="checkbox-container">
        <label>HDMI (TV)
          <input type="number" min="0" value="0" class="cantidad-equipo" data-equipo="HDMI (TV)">
        </label>
        <label>HDMI (ONESCREEN)
          <input type="number" min="0" value="0" class="cantidad-equipo" data-equipo="HDMI (ONESCREEN)">
        </label>
        <label>CONTROL (Videobeam)
          <input type="number" min="0" value="0" class="cantidad-equipo" data-equipo="CONTROL VB">
        </label>
        <label>HDMI (Videobeam)
          <input type="number" min="0" value="0" class="cantidad-equipo" data-equipo="HDMI (VIDEOBEAM)">
        </label>
        <label>PORT√ÅTIL
          <input type="number" min="0" value="0" class="cantidad-equipo" data-equipo="PORTATIL">
        </label>
        <label>ANCHOR
          <input type="number" min="0" value="0" class="cantidad-equipo" data-equipo="ANCHOR">
        </label>
      </div>
      <input type="text" id="otros" placeholder="Otros equipos">
    </fieldset>

    <button onclick="agregarPrestamo()">Agregar</button>

</div>

<b> ¬© Juan Ladino - 2025 </b>

<!-- üî• AQU√ç VIENE EL SCRIPT COMPLETO Y ORIGINAL, SIN NADA BORRADO -->
<script type="module">
// Firebase imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, getDoc, setDoc, deleteDoc, updateDoc, doc
} from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

// Config POSGRADOS (ya en tu proyecto)
const firebaseConfig = {
  apiKey: "AIzaSyC7llIg5wLu8P_5WBbjg4GW3orZZ1w8_vE",
  authDomain: "prestamos-1efef.firebaseapp.com",
  projectId: "prestamos-1efef",
  storageBucket: "prestamos-1efef.firebasestorage.app",
  messagingSenderId: "977813237082",
  appId: "1:977813237082:web:576287c13c305db3811763"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ------------------------ UTILIDADES ------------------------
function normalizarTipoUsuario(raw) {
  if (!raw) return "";
  const v = raw.trim().toLowerCase();
  if (v.includes("doc") || v.includes("profe") || v.includes("form")) return "Docente";
  if (v.includes("estud") || v.includes("alu") || v.includes("apr")) return "Estudiante";
  if (v.includes("admin") || v.includes("admi")) return "Administrativo";
  return ""; // inv√°lido
}

function calcularHorasNetas(horaInicio, horaFin) {
  try {
    if (!horaInicio || !horaFin) return 0;
    const inicio = new Date(`1970-01-01T${horaInicio}:00`);
    const fin = new Date(`1970-01-01T${horaFin}:00`);
    const diff = (fin - inicio) / (1000 * 60 * 60);
    return diff > 0 ? Math.round((diff + Number.EPSILON) * 100) / 100 : 0;
  } catch (e) {
    console.error('calcularHorasNetas', e);
    return 0;
  }
}

// ------------------------ B√öSQUEDA Y USUARIOS ------------------------
window.buscarUsuario = async function () {
  const documento = document.getElementById('documento').value.trim();
  if (!documento) return;
  try {
    const ref = doc(db, 'usuarios', documento);
    const snap = await getDoc(ref);
    if (snap.exists()) {
      const u = snap.data();
      document.getElementById('nombre').value = u.nombre || '';
      document.getElementById('tipoUsuario').value = u.tipoUsuario || '';
      document.getElementById('facultad').value = u.facultad || '';
    }
  } catch (e) { console.error('buscarUsuario', e); }
};

async function guardarUsuarioSiNoExiste(documento, datos) {
  try {
    const usuarioRef = doc(db, 'usuarios', documento);
    const usuarioSnap = await getDoc(usuarioRef);
    if (!usuarioSnap.exists()) {
      await setDoc(usuarioRef, datos);
    } else {
      // posible actualizaci√≥n si hubo cambios
      const actuales = usuarioSnap.data() || {};
      const cambios = {};
      if (datos.nombre && datos.nombre !== actuales.nombre) cambios.nombre = datos.nombre;
      if (datos.tipoUsuario && datos.tipoUsuario !== actuales.tipoUsuario) cambios.tipoUsuario = datos.tipoUsuario;
      if (datos.facultad && datos.facultad !== actuales.facultad) cambios.facultad = datos.facultad;
      if (Object.keys(cambios).length > 0) await updateDoc(usuarioRef, cambios);
    }
  } catch (e) { console.error('guardarUsuarioSiNoExiste', e); }
}

// ------------------------ SALONES DIN√ÅMICOS ------------------------
window.agregarSalon = function () {
  const contenedor = document.getElementById('salones-container');
  const nuevo = document.createElement('div');
  nuevo.className = 'salon-item';
  nuevo.innerHTML = `
    <input type="text" class="salon" placeholder="Sal√≥n (ej: 301P)">
    <label>Hora entrega:</label>
    <input type="time" class="horaEntrega">
    <label>Hora devoluci√≥n:</label>
    <input type="time" class="horaDevolucion">
    <button type="button" onclick="this.parentElement.remove()">‚ùå</button>
  `;
  contenedor.appendChild(nuevo);
};

// ------------------------ AGREGAR PR√âSTAMO ------------------------
window.agregarPrestamo = async function () {
  try {
    const nombre = document.getElementById('nombre').value.trim();
    const documento = document.getElementById('documento').value.trim();
    const tipoRaw = document.getElementById('tipoUsuario').value.trim();
    const facultad = document.getElementById('facultad').value.trim();

    // Salones
    const salones = [];
    document.querySelectorAll('#salones-container .salon-item').forEach(div => {
      const nombreSalon = div.querySelector('.salon').value.trim();
      const horaEntrega = div.querySelector('.horaEntrega').value;
      const horaDevolucion = div.querySelector('.horaDevolucion').value;
      if (nombreSalon && horaEntrega && horaDevolucion) {
        const horas = calcularHorasNetas(horaEntrega, horaDevolucion);
        salones.push({ nombre: nombreSalon, horaEntrega, horaDevolucion, horas });
      }
    });

    // Equipos
    const cantidades = document.querySelectorAll('.cantidad-equipo');
    const equipos = [];
    cantidades.forEach(input => {
      const cantidad = parseInt(input.value) || 0;
      if (cantidad > 0) equipos.push({ nombre: input.dataset.equipo, cantidad });
    });
    const otros = document.getElementById('otros').value.trim();
    if (otros) equipos.push({ nombre: otros, cantidad: 1 });

    // Validaciones b√°sicas
    if (!nombre || !documento || !facultad) { alert('Por favor complete todos los campos.'); return; }
    if (salones.length === 0) { alert('Agregue al menos un sal√≥n con horario.'); return; }
    if (equipos.length === 0) { alert('Agregue al menos un equipo.'); return; }

    // Validar tipoUsuario
    const tipoNormal = normalizarTipoUsuario(tipoRaw);
    if (!tipoNormal) { alert('‚ö†Ô∏è Tipo de usuario inv√°lido. S√≥lo: Docente, Estudiante o Administrativo.'); return; }
    const tipoUsuario = tipoNormal;

    // Sumar horas totales
    const totalHoras = salones.reduce((s, it) => s + (parseFloat(it.horas) || 0), 0);

    const fecha = new Date().toLocaleDateString('es-CO');
    const id = `${documento}_${Date.now()}`;

    const prestamo = { nombre, documento, tipoUsuario, facultad, salones, totalHoras, equipos, devuelto: false, fecha };

    // Guardar
    await setDoc(doc(db, 'prestamos', id), prestamo);
    await guardarUsuarioSiNoExiste(documento, { nombre, documento, tipoUsuario, facultad });

    alert('‚úÖ Pr√©stamo registrado correctamente.');

    // Limpiar formulario
    document.getElementById('documento').value = '';
    document.getElementById('nombre').value = '';
    document.getElementById('tipoUsuario').value = '';
    document.getElementById('facultad').value = '';
    document.getElementById('otros').value = '';

    // Reiniciar salones
    const salonesContainer = document.getElementById('salones-container');
    salonesContainer.innerHTML = `
      <div class="salon-item">
        <input type="text" class="salon" placeholder="Sal√≥n (ej: 301P)">
        <label>Hora entrega:</label>
        <input type="time" class="horaEntrega">
        <label>Hora devoluci√≥n:</label>
        <input type="time" class="horaDevolucion">
      </div>
    `;

    // Reiniciar cantidades
    document.querySelectorAll('.cantidad-equipo').forEach(i => i.value = 0);

    if (typeof cargarDatos === 'function') cargarDatos();
  } catch (e) { console.error('agregarPrestamo', e); alert('Error al guardar. Revisa consola.'); }
};

// ------------------------ LISTAR / EDITAR / BORRAR / DEVOLVER ------------------------
async function cargarDatos() {
  const contenedor = document.getElementById('listaPrestamos');
  if (!contenedor) return;
  contenedor.innerHTML = '';
  try {
    const snapshot = await getDocs(collection(db, 'prestamos'));
    const prestamos = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    // ordenar por fecha descendente si existe
    prestamos.sort((a,b)=> (b.fecha || 0) > (a.fecha || 0) ? 1 : -1);

    prestamos.forEach(prestamo => {
      const card = document.createElement('div');
      card.className = 'card';
      card.classList.add(prestamo.devuelto ? 'prestamo-devuelto' : 'prestamo-activo');

      const salonesText = Array.isArray(prestamo.salones)
        ? prestamo.salones.map(s => `${s.nombre} (${s.horaEntrega} ‚Üí ${s.horaDevolucion})`).join(', ')
        : (prestamo.salon || 'No registrado');

      const equiposText = Array.isArray(prestamo.equipos)
        ? prestamo.equipos.map(e => `${e.nombre || e} (x${e.cantidad||1})`).join(', ')
        : 'Sin datos';

      card.innerHTML = `
        <div class="card-header">
          <span>${prestamo.nombre} - ${prestamo.documento}</span>
          <span>${prestamo.devuelto ? 'Devuelto' : 'En pr√©stamo'}</span>
        </div>
        <div class="card-body">
          <p><strong>Tipo de Usuario:</strong> ${prestamo.tipoUsuario}</p>
          <p><strong>Facultad:</strong> ${prestamo.facultad}</p>
          <p><strong>Salones:</strong> ${salonesText}</p>
          <p><strong>Total horas:</strong> ${prestamo.totalHoras || 0}</p>
          <p><strong>Equipos:</strong> ${equiposText}</p>
          <button class="btn-edit" onclick="editarPrestamo('${prestamo.id}')">Editar</button>
          <button class="btn-return" onclick="marcarDevuelto('${prestamo.id}')">Devolver</button>
          <button class="btn-delete" onclick="eliminarPrestamo('${prestamo.id}')">Eliminar</button>
        </div>
      `;

      card.addEventListener('click', () => card.classList.toggle('expanded'));
      contenedor.appendChild(card);
    });
  } catch (e) { console.error('cargarDatos', e); }
}

window.cargarDatos = cargarDatos;

async function marcarDevuelto(id) {
  try {
    const ref = doc(db, 'prestamos', id);
    await updateDoc(ref, { devuelto: true });
    if (typeof cargarDatos === 'function') cargarDatos();
  } catch (e) { console.error('marcarDevuelto', e); }
}

async function editarPrestamo(id) {
  try {
    const ref = doc(db, 'prestamos', id);
    const snap = await getDoc(ref);
    if (!snap.exists()) { alert('Pr√©stamo no encontrado'); return; }
    const prestamo = snap.data();

    document.getElementById('documento').value = prestamo.documento || '';
    document.getElementById('nombre').value = prestamo.nombre || '';
    document.getElementById('tipoUsuario').value = prestamo.tipoUsuario || '';
    document.getElementById('facultad').value = prestamo.facultad || '';

    // Cargar salones
    const sc = document.getElementById('salones-container'); sc.innerHTML = '';
    (prestamo.salones || []).forEach(s => {
      const div = document.createElement('div'); div.className = 'salon-item';
      div.innerHTML = `
        <input type="text" class="salon" value="${s.nombre}">
        <label>Hora entrega:</label>
        <input type="time" class="horaEntrega" value="${s.horaEntrega}">
        <label>Hora devoluci√≥n:</label>
        <input type="time" class="horaDevolucion" value="${s.horaDevolucion}">
        <button type="button" onclick="this.parentElement.remove()">‚ùå</button>
      `; sc.appendChild(div);
    });

    // Cargar equipos
    document.querySelectorAll('.cantidad-equipo').forEach(i=>i.value=0);
    document.getElementById('otros').value = '';
    (prestamo.equipos || []).forEach(e=>{
      const nombre = e.nombre || e;
      const cantidad = e.cantidad || 1;
      const input = Array.from(document.querySelectorAll('.cantidad-equipo')).find(x=>x.dataset.equipo===nombre);
      if (input) input.value = cantidad; else document.getElementById('otros').value = nombre;
    });

    // Borrar doc para re-guardar (siguiendo flujo original)
    await deleteDoc(ref);
    if (typeof cargarDatos === 'function') cargarDatos();
  } catch (e) { console.error('editarPrestamo', e); }
}

async function eliminarPrestamo(id) {
  try {
    const ref = doc(db, 'prestamos', id);
    const snap = await getDoc(ref);
    if (!snap.exists()) return;
    const prestamoEliminado = snap.data();
    await deleteDoc(ref);

    // guardar en historial
    const fechaHoy = new Date().toLocaleDateString('es-CO');
    const histId = `${prestamoEliminado.documento}_${Date.now()}`;
    await setDoc(doc(db, 'historial', histId), { ...prestamoEliminado, fecha: fechaHoy });

    if (typeof cargarDatos === 'function') cargarDatos();
  } catch (e) { console.error('eliminarPrestamo', e); }
}

// Iniciar
window.addEventListener('DOMContentLoaded', cargarDatos);

// Exponer helpers
window.firestore = { db, getFirestore, collection, doc, getDocs, getDoc, setDoc };
</script>

</body>
</html>
