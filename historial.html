<!DOCTYPE html>
<html lang="es">
<head>
<link rel="icon" type="image/png" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Préstamos</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import {
          getFirestore,
          getDocs,
          collection, 
          addDoc
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        
        // Configuración Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyC7llIg5wLu8P_5WBbjg4GW3orZZ1w8_vE",
          authDomain: "prestamos-1efef.firebaseapp.com",
          projectId: "prestamos-1efef",
          storageBucket: "prestamos-1efef.firebasestorage.app",
          messagingSenderId: "977813237082",
          appId: "1:977813237082:web:576287c13c305db3811763"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        import { deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

window.borrarHistorialFirestore = async function () {
  if (!confirm("¿Estás seguro de que deseas borrar TODO el historial de Firestore? Esta acción no se puede deshacer.")) return;

  const snapshot = await getDocs(collection(db, "historial"));
  let borrados = 0;

  for (const docu of snapshot.docs) {
    await deleteDoc(docu.ref);
    borrados++;
  }

  alert(`Historial borrado: ${borrados} registros eliminados.`);
  cargarHistorial();
};



        
        // Leer historial desde Firestore
        async function cargarHistorial() {
          const tabla = document.getElementById("historialPrestamos");
          tabla.innerHTML = "";
        
          const snapshot = await getDocs(collection(db, "historial"));
          const prestamos = [];
        
          snapshot.forEach(doc => {
            const p = doc.data();
            prestamos.push(p);
          });
        
          // Orden inverso (del más reciente al más antiguo)
          prestamos.reverse().forEach(p => {
            const row = `<tr>
              <td>${p.fecha || "N/A"}</td>
              <td>${p.nombre}</td>
              <td>${p.documento}</td>
              <td>${p.tipoUsuario}</td>
              <td>${p.facultad}</td>
              <td>${p.salon}</td>
              <td>${p.horaEntrega}</td>
              <td>${p.horaDevolucion}</td>
              <td>${(p.equipos || []).join(" - ")}</td>
              <td>${calcularHorasNetas(p.horaEntrega, p.horaDevolucion)}</td>
            </tr>`;
            tabla.innerHTML += row;
          });
        
          // Guardar copia local en memoria para exportación
          window.historialFire = prestamos;
        }
        
        window.filtrarHistorial = function () {
          let filtro = document.getElementById("busqueda").value.toLowerCase();
          let filas = document.querySelectorAll("#historialPrestamos tr");
          filas.forEach(fila => {
            let textoFila = fila.innerText.toLowerCase();
            fila.style.display = textoFila.includes(filtro) ? "" : "none";
          });
        };
        
        window.exportarHistorial = function () {
          const historial = window.historialFire || [];
          if (historial.length === 0) {
            alert("No hay datos para exportar.");
            return;
          }
        
          let csvContent = "Fecha,Nombre,Documento,Tipo de Usuario,Facultad,Salón,Hora Entrega,Hora Devolución,Equipos,Horas Netas\n";
          historial.forEach(p => {
            const equipos = p.equipos ? p.equipos.join(" - ") : "";
            const horasNetas = calcularHorasNetas(p.horaEntrega, p.horaDevolucion);
            csvContent += `"${p.fecha || 'N/A'}","${p.nombre}","${p.documento}","${p.tipoUsuario}","${p.facultad}","${p.salon}","${p.horaEntrega}","${p.horaDevolucion}","${equipos}","${horasNetas}"\n`;
          });
        
          const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "Historial_Prestamos.csv";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        };
        
        window.onload = cargarHistorial;
        </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 95%;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        input {
            margin: 5px 0;
            padding: 10px;
            width: 98%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
	select {
            margin: 5px 0;
            padding: 10px;
            width: 94%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
	button {
            margin: 5px 0;
            padding: 10px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        th {
            background: #007BFF;
            color: white;
        }
/* Estilos para el menú */
        nav {
            background-color: #007BFF;
            padding: 10px;
            color: white;
        }
        nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: space-around;
        }
        nav ul li {
            display: inline;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            display: block;
        }
        nav ul li a:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
<!-- Menú de navegación -->
    <nav>
        <ul>
            <li><a href="index.html" onclick="cargarSeccion('gestion')">Gestión de préstamos</a></li>
            <li><a href="activos.html" onclick="cargarSeccion('activos')">Préstamos activos</a></li>
            <li><a href="historial.html" onclick="cargarSeccion('historial')">Historial</a></li>
            <li><a href="estadisticas.html" onclick="cargarSeccion('estadisticas')">Estadísticas</a></li>
        </ul>
    </nav>
    <div class="container">
        <h2>Historial de Préstamos</h2>
        

        <!-- Campo de búsqueda y filtros -->
        <input type="text" id="busqueda" placeholder="Buscar por nombre, documento o fecha" onkeyup="filtrarHistorial()">
        <button onclick="exportarHistorial()">Exportar a CSV</button>

        <!-- Tabla de historial -->
        <table>
            <thead>
                <tr>
		    <th>Fecha</th>
                    <th>Nombre</th>
                    <th>Documento</th>
                    <th>Tipo de Usuario</th>
                    <th>Facultad</th>
                    <th>Salón</th>
                    <th>Hora Entrega</th>
                    <th>Hora Devolución</th>
                    <th>Equipos</th>
                    <th>Horas Netas</th>
                </tr>
            </thead>
            <tbody id="historialPrestamos">
            </tbody>
        </table>
<br>
<br>
<br>
<button onclick="borrarHistorialFirestore()" style="background-color: #ff4444; color: white;">
    Borrar Historial y Estadísticas
  </button>
  

    </div>

    <script>

function calcularHorasNetas(horaEntrega, horaDevolucion) {
  if (!horaEntrega || !horaDevolucion) return 0;

  let entrega = new Date(`1970-01-01T${horaEntrega}:00`);
  let devolucion = new Date(`1970-01-01T${horaDevolucion}:00`);
  let diferencia = devolucion - entrega;

  // Retornar solo si es válido
  return isNaN(diferencia) ? 0 : Math.max(0, diferencia / (1000 * 60 * 60));
}

	// Función para borrar el historial
function borrarHistorial() {
    if (confirm("¿Estás seguro de que deseas borrar todo el historial? Esta acción no se puede deshacer.")) {
        localStorage.removeItem("historial"); // Elimina el historial del localStorage
        cargarHistorial(); // Recarga la tabla para reflejar que no hay datos
        alert("El historial ha sido borrado correctamente.");
    }
}

        // Función para calcular horas netas en formato decimal
        function calcularHorasNetas(horaEntrega, horaDevolucion) {
            let entrega = new Date(`1970-01-01T${horaEntrega}:00`);
            let devolucion = new Date(`1970-01-01T${horaDevolucion}:00`);
            let diferencia = devolucion - entrega; // Diferencia en milisegundos
            return (diferencia / (1000 * 60 * 60)).toFixed(2); // Convertir a horas con 2 decimales
        }

        function cargarHistorial() {
    let historial = JSON.parse(localStorage.getItem("historial")) || [];
    let historialTabla = document.getElementById("historialPrestamos");
    historialTabla.innerHTML = "";

    // Invertir el orden del historial
    historial.reverse().forEach(p => {
        let row = `<tr>
            <td>${p.fecha || 'N/A'}</td> <!-- Nueva columna -->
            <td>${p.nombre}</td>
            <td>${p.documento}</td>
            <td>${p.tipoUsuario}</td>
            <td>${p.facultad}</td>
            <td>${p.salon}</td>
            <td>${p.horaEntrega}</td>
            <td>${p.horaDevolucion}</td>
            <td>${p.equipos.join(" - ")}</td>
            <td>${calcularHorasNetas(p.horaEntrega, p.horaDevolucion)}</td>
        </tr>`;
        historialTabla.innerHTML += row;
    });
}

        // Función para filtrar el historial
        function filtrarHistorial() {
            let filtro = document.getElementById("busqueda").value.toLowerCase();
            let filas = document.querySelectorAll("#historialPrestamos tr");
            filas.forEach(fila => {
                let textoFila = fila.innerText.toLowerCase();
                fila.style.display = textoFila.includes(filtro) ? "" : "none";
            });
        }

        function exportarHistorial() {
    let historial = JSON.parse(localStorage.getItem("historial")) || [];
    if (historial.length === 0) {
        alert("No hay datos en el historial para exportar.");
        return;
    }

    // Encabezado con la nueva columna de Fecha
    let csvContent = "Fecha,Nombre,Documento,Tipo de Usuario,Facultad,Salón,Hora Entrega,Hora Devolución,Equipos,Horas Netas\n";

    historial.forEach(p => {
        let equipos = p.equipos ? p.equipos.join(" - ") : "";
        let horasNetas = calcularHorasNetas(p.horaEntrega, p.horaDevolucion);
        // Agregar la fecha al CSV
        csvContent += `"${p.fecha || 'N/A'}","${p.nombre}","${p.documento}","${p.tipoUsuario}","${p.facultad}","${p.salon}","${p.horaEntrega}","${p.horaDevolucion}","${equipos}","${horasNetas}"\n`;
    });

    let blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Historial_Prestamos.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

        // Cargar el historial al abrir la página
        document.addEventListener("DOMContentLoaded", function () {
            cargarHistorial();
        });
    </script>
</body>
</html>